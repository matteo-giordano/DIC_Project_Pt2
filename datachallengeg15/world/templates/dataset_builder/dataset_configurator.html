<!-- Dataset Configurator Panel -->
<div class="generator-options" id="dataset-config-panel">
    <div class="section-title">Dataset Configuration</div>
    
    <div class="config-note">
        <div class="note-icon">ℹ️</div>
        <div class="note-text">
            This configuration controls the maze generation parameters for your dataset. 
            Each enabled generator will create mazes with all possible combinations of parameter values.
        </div>
    </div>
    
    <div class="global-options">
        <div class="option-row">
            <div class="checkbox-container">
                <input type="checkbox" name="ensure_connected_global" id="ensure-connected-global" checked>
                <label for="ensure-connected-global">Ensure all mazes are fully connected</label>
            </div>
        </div>
        <div class="option-row">
            <div class="checkbox-container">
                <input type="checkbox" name="ensure_unique_global" id="ensure-unique-global" checked>
                <label for="ensure-unique-global">Ensure all mazes are unique</label>
            </div>
        </div>
    </div>
    
    <h3>Generator Settings</h3>
    
    <!-- Generator Configuration Sections -->
    {% for gen_type, gen_info in generators.items() %}
    <div class="config-section" data-generator="{{ gen_type }}" data-enabled="{{ gen_type in generator_config.generators }}">
        <div class="config-header">
            <div class="config-title">{{ gen_info.name }}</div>
            <div class="status-indicator-container">
                <label class="toggle-switch">
                    <input type="checkbox" class="generator-toggle" 
                           name="{{ gen_type }}_enabled" 
                           {{ 'checked' if gen_type in generator_config.generators else '' }}>
                    <span class="toggle-slider"></span>
                </label>
                <div class="status-indicator">
                    <div class="status-light"></div>
                </div>
            </div>
        </div>
        <div class="config-content" {% if gen_type in generator_config.generators %}style="display: block"{% endif %}>
            {% if gen_type == 'manual' %}
            <!-- Special case for manual generator - simple toggle only -->
            <div class="param-grid">
                <div class="param-item" style="grid-column: span 2;">
                    <div class="config-note">
                        <div class="note-icon">ℹ️</div>
                        <div class="note-text">
                            When enabled, all saved manual mazes will be included in the dataset when you click "Generate Dataset".
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="param-grid">
                <!-- Count per Configuration -->
                <div class="param-item">
                    <label class="param-label">Maps per Configuration</label>
                    <input type="number" class="param-value" name="{{ gen_type }}-count_per_config" 
                           value="{{ generator_config.generators[gen_type].count_per_config if gen_type in generator_config.generators else 10 }}" 
                           min="1" max="100">
                </div>
                
                <!-- Width Parameter -->
                <div class="param-item">
                    <label class="param-label">Width Values</label>
                    <div class="array-container" 
                         data-param-name="{{ gen_type }}-width" 
                         data-param-type="number" 
                         data-param-step="2"
                         data-param-min="3"
                         data-param-max="101">
                        {% if gen_type in generator_config.generators and generator_config.generators[gen_type].width %}
                            {% for width in generator_config.generators[gen_type].width %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-width[]" 
                                       value="{{ width }}" min="3" max="101" step="2">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-width[]" 
                                       value="21" min="3" max="101" step="2">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                        {% endif %}
                    </div>
                    <button type="button" class="array-add">+ Add Width</button>
                </div>
                
                <!-- Height Parameter -->
                <div class="param-item">
                    <label class="param-label">Height Values</label>
                    <div class="array-container" 
                         data-param-name="{{ gen_type }}-height" 
                         data-param-type="number" 
                         data-param-step="2"
                         data-param-min="3"
                         data-param-max="101">
                        {% if gen_type in generator_config.generators and generator_config.generators[gen_type].height %}
                            {% for height in generator_config.generators[gen_type].height %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-height[]" 
                                       value="{{ height }}" min="3" max="101" step="2">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-height[]" 
                                       value="21" min="3" max="101" step="2">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                        {% endif %}
                    </div>
                    <button type="button" class="array-add">+ Add Height</button>
                </div>
                
                <!-- Generator-specific parameters -->
                {% if gen_type == 'terrain' %}
                <div class="param-item">
                    <label class="param-label">Blob Density Values</label>
                    <div class="array-container" 
                         data-param-name="{{ gen_type }}-blob_density" 
                         data-param-type="number" 
                         data-param-step="0.001"
                         data-param-min="0.001"
                         data-param-max="0.05">
                        {% if gen_type in generator_config.generators and generator_config.generators[gen_type].blob_density %}
                            {% for density in generator_config.generators[gen_type].blob_density %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-blob_density[]" 
                                       value="{{ density }}" min="0.001" max="0.05" step="0.001">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-blob_density[]" 
                                       value="0.005" min="0.001" max="0.05" step="0.001">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                        {% endif %}
                    </div>
                    <button type="button" class="array-add">+ Add Density</button>
                </div>
                {% endif %}
                
                {% if gen_type == 'gaussian' %}
                <div class="param-item">
                    <label class="param-label">Threshold Values</label>
                    <div class="array-container" 
                         data-param-name="{{ gen_type }}-threshold" 
                         data-param-type="number" 
                         data-param-step="0.05"
                         data-param-min="0.5"
                         data-param-max="0.9">
                        {% if gen_type in generator_config.generators and generator_config.generators[gen_type].threshold %}
                            {% for threshold in generator_config.generators[gen_type].threshold %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-threshold[]" 
                                       value="{{ threshold }}" min="0.5" max="0.9" step="0.05">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-threshold[]" 
                                       value="0.65" min="0.5" max="0.9" step="0.05">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                        {% endif %}
                    </div>
                    <button type="button" class="array-add">+ Add Threshold</button>
                </div>
                
                <div class="param-item">
                    <label class="param-label">Sigma X Values</label>
                    <div class="array-container" 
                         data-param-name="{{ gen_type }}-sigma_x" 
                         data-param-type="number" 
                         data-param-step="0.1"
                         data-param-min="0.1"
                         data-param-max="5.0">
                        {% if gen_type in generator_config.generators and generator_config.generators[gen_type].sigma_x %}
                            {% for sigma in generator_config.generators[gen_type].sigma_x %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-sigma_x[]" 
                                       value="{{ sigma }}" min="0.1" max="5.0" step="0.1">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-sigma_x[]" 
                                       value="1.0" min="0.1" max="5.0" step="0.1">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                        {% endif %}
                    </div>
                    <button type="button" class="array-add">+ Add Sigma X</button>
                </div>
                
                <div class="param-item">
                    <label class="param-label">Sigma Y Values</label>
                    <div class="array-container" 
                         data-param-name="{{ gen_type }}-sigma_y" 
                         data-param-type="number" 
                         data-param-step="0.1"
                         data-param-min="0.1"
                         data-param-max="5.0">
                        {% if gen_type in generator_config.generators and generator_config.generators[gen_type].sigma_y %}
                            {% for sigma in generator_config.generators[gen_type].sigma_y %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-sigma_y[]" 
                                       value="{{ sigma }}" min="0.1" max="5.0" step="0.1">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="array-item">
                                <input type="number" class="array-item-value" name="{{ gen_type }}-sigma_y[]" 
                                       value="1.0" min="0.1" max="5.0" step="0.1">
                                <button type="button" class="array-item-remove">×</button>
                            </div>
                        {% endif %}
                    </div>
                    <button type="button" class="array-add">+ Add Sigma Y</button>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    
    <div class="config-actions">
        <button class="config-btn" id="reset-generator-config">Reset</button>
        <button class="config-btn primary" id="save-generator-config">Generate Dataset</button>
    </div>
    
    <div id="generate-progress-container" class="progress-container" style="display: none;">
        <div class="progress-bar-label">Generating dataset...</div>
        <div class="progress-bar-outer">
            <div class="progress-bar-inner" id="generate-progress-bar"></div>
        </div>
        <div class="progress-status" id="generate-progress-status">Initializing...</div>
    </div>
    
    <div class="hint-text">
        This configuration controls the range of parameters used when generating the full dataset.
        Each generator can have different parameter sets to explore.
    </div>
</div>

<!-- Dataset Configurator JS -->
<script>
// Function to initialize the dataset configurator
function initDatasetConfigurator() {
    // Make generator cards clickable
    document.querySelectorAll('.config-section').forEach(section => {
        // Get header and content elements
        const header = section.querySelector('.config-header');
        const content = section.querySelector('.config-content');
        const toggle = section.querySelector('.generator-toggle');
        
        if (!header || !content || !toggle) return;
        
        // Set initial content visibility based on enabled state
        const isEnabled = section.getAttribute('data-enabled') === 'true';
        content.style.display = isEnabled ? 'block' : 'none';
        toggle.checked = isEnabled;
        section.setAttribute('data-enabled', isEnabled.toString());
        
        // Toggle visibility when clicking the header
        header.addEventListener('click', function(e) {
            // Don't toggle if clicking on the checkbox directly
            if (e.target === toggle || e.target.closest('.toggle-switch')) {
                return;
            }
            
            // Toggle display of content
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        });
        
        // Toggle enabled state when checkbox changes
        toggle.addEventListener('change', function() {
            const isChecked = this.checked;
            section.setAttribute('data-enabled', isChecked.toString());
            
            // Make sure content is visible when enabled
            if (isChecked && (content.style.display === 'none' || content.style.display === '')) {
                content.style.display = 'block';
            }
        });
    });
    
    // Handle add/remove buttons for array items
    document.querySelectorAll('.array-add').forEach(btn => {
        btn.addEventListener('click', function() {
            const container = this.previousElementSibling;
            const paramName = container.getAttribute('data-param-name');
            const paramType = container.getAttribute('data-param-type');
            const paramStep = container.getAttribute('data-param-step');
            const paramMin = container.getAttribute('data-param-min');
            const paramMax = container.getAttribute('data-param-max');
            
            // Get the last item to clone its structure
            const lastItem = container.querySelector('.array-item:last-child');
            if (!lastItem) return;
            
            // Create a new item
            const newItem = document.createElement('div');
            newItem.className = 'array-item';
            
            // Create input
            const input = document.createElement('input');
            input.type = paramType;
            input.className = 'array-item-value';
            input.name = paramName + '[]';
            
            if (paramType === 'number') {
                input.step = paramStep || '1';
                input.min = paramMin || '0';
                input.max = paramMax || '100';
                
                // Get the last input value
                const lastValue = parseFloat(lastItem.querySelector('input').value);
                const step = parseFloat(paramStep || '1');
                
                // Set a reasonable new value (increment by step)
                input.value = lastValue + step;
            } else {
                input.value = '';
            }
            
            // Create remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'array-item-remove';
            removeBtn.textContent = '×';
            removeBtn.addEventListener('click', function() {
                this.parentNode.remove();
            });
            
            // Add elements to the new item
            newItem.appendChild(input);
            newItem.appendChild(removeBtn);
            
            // Add to container
            container.appendChild(newItem);
        });
    });
    
    // Set up event delegation for remove buttons
    document.querySelectorAll('.array-container').forEach(container => {
        container.addEventListener('click', function(e) {
            if (e.target.classList.contains('array-item-remove')) {
                // Check if this is the last item
                const items = this.querySelectorAll('.array-item');
                if (items.length <= 1) {
                    alert('Cannot remove the last item. At least one value is required.');
                    return;
                }
                
                // Remove the item
                e.target.parentNode.remove();
            }
        });
    });
    
    // Save configuration button
    document.getElementById('save-generator-config')?.addEventListener('click', function() {
        // Disable the button to prevent multiple clicks
        this.disabled = true;
        this.textContent = 'Processing...';
        
        // Collect configuration data
        const configData = {
            name: document.getElementById('dataset-name').textContent,
            generators: {}
        };
        
        // Process each generator section
        document.querySelectorAll('.config-section').forEach(section => {
            const generatorType = section.getAttribute('data-generator');
            const isEnabled = section.querySelector('.generator-toggle').checked;
            
            if (isEnabled) {
                // Special case for manual generator
                if (generatorType === 'manual') {
                    configData.generators[generatorType] = {
                        // Add basic configuration for manual generator
                        count_per_config: 1,  // Default value
                        width: [21],          // Default width
                        height: [21]          // Default height
                    };
                } else {
                    configData.generators[generatorType] = {
                        count_per_config: parseInt(section.querySelector(`input[name="${generatorType}-count_per_config"]`).value)
                    };
                    
                    // Process array parameters (width, height, etc.)
                    section.querySelectorAll('.array-container').forEach(container => {
                        const paramName = container.getAttribute('data-param-name').split('-')[1]; // Extract parameter name
                        const inputs = container.querySelectorAll('.array-item-value');
                        const values = [];
                        
                        inputs.forEach(input => {
                            const value = input.type === 'number' ? parseFloat(input.value) : input.value;
                            values.push(value);
                        });
                        
                        configData.generators[generatorType][paramName] = values;
                    });
                }
            }
        });
        
        // Get global settings
        const ensureConnected = document.getElementById('ensure-connected-global').checked;
        const ensureUnique = document.getElementById('ensure-unique-global').checked;
        
        // Show progress bar
        const progressContainer = document.getElementById('generate-progress-container');
        const progressBar = document.getElementById('generate-progress-bar');
        const progressStatus = document.getElementById('generate-progress-status');
        
        progressContainer.style.display = 'block';
        progressBar.style.width = '10%';
        progressStatus.textContent = 'Step 1/3: Saving configuration...';
        
        // Save the configuration
        fetch('/save_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                config: configData,
                ensure_connected: ensureConnected,
                ensure_unique: ensureUnique
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update progress
                progressBar.style.width = '30%';
                progressStatus.textContent = 'Step 2/3: Configuration saved. Generating dataset...';
                
                // Generate the full dataset
                return fetch('/generate_full_dataset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ensure_connected: ensureConnected,
                        ensure_unique: ensureUnique
                    })
                });
            } else {
                throw new Error(data.error || 'Failed to save configuration');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update progress bar to complete
                progressBar.style.width = '100%';
                progressStatus.textContent = `Step 3/3: Dataset successfully generated with ${data.map_count} maps!`;
                
                // Store the dataset path for later use
                localStorage.setItem('lastDatasetPath', data.dataset_path);
                
                // Reset the button state after a successful generation
                const generateButton = document.getElementById('save-generator-config');
                if (generateButton) {
                    generateButton.textContent = 'Generate Dataset';
                    generateButton.disabled = false;
                }
                
                // Create a notification
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.innerHTML = `
                    <div class="notification-title">Dataset Generated!</div>
                    <div class="notification-content">
                        <p>Dataset saved to: ${data.dataset_path}</p>
                        <p>Contains ${data.map_count} maps</p>
                        ${data.manual_mazes_added ? `<p>Added ${data.manual_mazes_added} manual mazes</p>` : ''}
                        ${data.deduplication_info && data.deduplication_info.enabled ? 
                          `<p>Removed ${data.deduplication_info.duplicates_removed} duplicate mazes</p>` : ''}
                    </div>
                    <div class="notification-actions">
                        <a href="${data.load_url}" class="notification-btn primary">Explore Dataset</a>
                        <button class="notification-btn secondary close-notification">Close</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Handle close button
                notification.querySelector('.close-notification').addEventListener('click', function() {
                    notification.remove();
                });
                
                // Redirect to home when 'Explore Dataset' is clicked
                notification.querySelector('.notification-btn.primary').addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Create a form to post to load_dataset
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = data.load_url;
                    
                    // Add dataset path as input
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'dataset_path';
                    input.value = data.dataset_path;
                    
                    // Add to form and submit
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                });
                
                // Auto-hide progress after 3 seconds
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    
                    // Make sure the button is fully reset
                    if (generateButton) {
                        generateButton.textContent = 'Generate Dataset';
                        generateButton.disabled = false;
                    }
                }, 3000);
            } else {
                throw new Error(data.error || 'Failed to generate dataset');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            progressStatus.textContent = 'Error: ' + error.message;
            progressStatus.style.color = 'var(--error-color)';
            
            // Reset progress bar
            progressBar.style.width = '0%';
            
            // Reset button state
            const generateButton = document.getElementById('save-generator-config');
            if (generateButton) {
                generateButton.textContent = 'Generate Dataset';
                generateButton.disabled = false;
            }
            
            // Reset color after 3 seconds
            setTimeout(() => {
                progressStatus.style.color = '';
                // Hide the progress container
                progressContainer.style.display = 'none';
            }, 3000);
        });
    });
    
    // Reset configuration button
    document.getElementById('reset-generator-config')?.addEventListener('click', function() {
        if (confirm('Reset all generator configurations to default values? Manually drawn mazes will be preserved.')) {
            // Instead of reloading the whole page, let's reload the configuration via AJAX
            fetch('/load_config', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Get all generator sections
                    document.querySelectorAll('.config-section').forEach(section => {
                        const generatorType = section.getAttribute('data-generator');
                        
                        // Skip manual generator - we want to keep it as is
                        if (generatorType === 'manual') return;
                        
                        // First, enable all non-manual generators by default
                        if (generatorType !== 'manual') {
                            const toggle = section.querySelector('.generator-toggle');
                            if (toggle) {
                                toggle.checked = true;
                                section.setAttribute('data-enabled', 'true');
                                section.querySelector('.config-content').style.display = 'block';
                            }
                        }
                        
                        // Reset configuration fields to defaults for this generator
                        const countInput = section.querySelector(`input[name="${generatorType}-count_per_config"]`);
                        if (countInput) {
                            countInput.value = 10; // Default count
                        }
                        
                        // Reset array parameters
                        section.querySelectorAll('.array-container').forEach(container => {
                            const paramName = container.getAttribute('data-param-name').split('-')[1];
                            const paramType = container.getAttribute('data-param-type');
                            const itemsContainer = container.querySelectorAll('.array-item');
                            
                            // Remove all items except the first one
                            for (let i = itemsContainer.length - 1; i > 0; i--) {
                                itemsContainer[i].remove();
                            }
                            
                            // Reset the first item to default value
                            const firstInput = container.querySelector('.array-item-value');
                            if (firstInput) {
                                if (paramName === 'width' || paramName === 'height') {
                                    firstInput.value = 21; // Default maze size
                                } else if (paramName === 'blob_density') {
                                    firstInput.value = 0.005; // Default for terrain
                                } else if (paramName === 'threshold') {
                                    firstInput.value = 0.65; // Default for gaussian
                                } else if (paramName === 'sigma_x' || paramName === 'sigma_y') {
                                    firstInput.value = 1.0; // Default for gaussian
                                }
                            }
                        });
                    });
                    
                    // Reset global settings
                    document.getElementById('ensure-connected-global').checked = true;
                    document.getElementById('ensure-unique-global').checked = true;
                    
                    // Show a confirmation
                    const progressContainer = document.getElementById('generate-progress-container');
                    const progressStatus = document.getElementById('generate-progress-status');
                    if (progressContainer && progressStatus) {
                        progressStatus.textContent = 'Configuration reset to defaults. Manual mazes preserved.';
                        progressStatus.style.color = 'var(--accent-color)';
                        progressContainer.style.display = 'block';
                        
                        // Hide after 3 seconds
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            progressStatus.style.color = '';
                        }, 3000);
                    }
                }
            })
            .catch(error => {
                console.error('Error resetting config:', error);
                alert('Error resetting configuration: ' + error.message);
            });
        }
    });
}

// Initialize the dataset configurator when the DOM is loaded
document.addEventListener('DOMContentLoaded', initDatasetConfigurator);
</script> 